
<project name="junit4" default="statuses">
    <path id="junit.classpath">
        <fileset dir="..">
            <include name="dependency/junit-*.jar" />
        </fileset>
    </path>

    <path id="tests.classpath">
        <path location="." />
        <path refid="junit.classpath" />
    </path>

    <taskdef resource="junit4.antlib.xml">
        <classpath refid="junit.classpath" />
        <classpath>
            <fileset dir="..">
                <include name="ant-junit4-*-standalone.jar" />
            </fileset>
        </classpath>
    </taskdef>

    <presetdef name="junit4.preconf">
        <junit4 haltonfailure="true" parallelism="1">
            <classpath refid="tests.classpath" />

            <listeners>
                <report-console 
                    showThrowable="true" 
                    showStackTraces="true" 
                    showOutputStream="true" 
                    showErrorStream="true"

                    showStatusOk="true"
                    showStatusError="true"
                    showStatusFailure="true"
                    showStatusIgnored="true"

                    showSuiteSummary="false"
                />
            </listeners>
        </junit4>
    </presetdef>

    <!-- Targets below are connected with test cases. -->

    <target name="sysstreams">
        <junit4.preconf>
            <fileset dir="${basedir}">
                <include name="**/tests/TestSysstreams.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="nojunit">
        <junit4>
            <fileset dir="${basedir}">
                <include name="**/tests/TestSysstreams.class" />
            </fileset>
        </junit4>
    </target>
    
    <target name="oldjunit">
        <junit4>
            <classpath>
                <path location="." />
                <fileset dir="${basedir}/../.." includes="lib/junit*.jar" />
            </classpath>
            <fileset dir="${basedir}">
                <include name="**/tests/TestStatuses.class" />
            </fileset>
        </junit4>
    </target>    

    <target name="statuses">
        <junit4.preconf>
            <fileset dir="${basedir}">
                <include name="**/tests/TestStatuses.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="ignoredSuite">
        <junit4.preconf>
            <fileset dir="${basedir}">
                <include name="**/tests/TestIgnoredSuite.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="beforeClassError">
        <junit4.preconf>
            <fileset dir="${basedir}">
                <include name="**/tests/TestBeforeClassError.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="afterClassError">
        <junit4.preconf>
            <fileset dir="${basedir}">
                <include name="**/tests/TestAfterClassError.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="hierarchicalSuiteDescription">
        <junit4.preconf>
            <fileset dir="${basedir}">
                <include name="**/tests/TestHierarchicalSuiteDescription.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="dir">
        <delete dir="empty" failonerror="false" />
        <mkdir dir="empty" />

        <junit4.preconf dir="empty">
            <fileset dir="${basedir}">
                <include name="**/tests/TestDir.class" />
            </fileset>
        </junit4.preconf>

        <fail message="Expected marker file to appear.">
            <condition>
                <not>
                    <available file="empty/touch.me" type="file" />
                </not>
            </condition>
        </fail>
    </target>

    <target name="maxmem">
        <junit4.preconf maxmemory="100m">
            <fileset dir="${basedir}">
                <include name="**/tests/TestMaxMem.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="jvmarg">
        <junit4.preconf>
            <jvmarg value="-Xmx100m" />
            <jvmarg value="-Dtest.param=foobar" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestMaxMem.class" />
                <include name="**/tests/TestJvmArg.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="sysproperty">
        <junit4.preconf>
            <sysproperty key="test.param" value="foobar" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestJvmArg.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="env">
        <junit4.preconf>
            <env key="env.variable" value="foobar" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestEnvVar.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="failureProperty">
        <junit4.preconf haltonfailure="false">
            <fileset dir="${basedir}">
                <include name="**/tests/TestStatuses.class" />
            </fileset>
        </junit4.preconf>

        <junit4.preconf haltonfailure="false" failureProperty="tests.failed">
            <fileset dir="${basedir}">
                <include name="**/tests/TestStatuses.class" />
            </fileset>
        </junit4.preconf>

        <fail message="Expected failure property to be set.">
            <condition>
                <not>
                    <isset property="tests.failed" />
                </not>
            </condition>
        </fail>
    </target>

    <target name="failureTypePassing">
        <junit4.preconf haltonfailure="false">
            <classpath>
                <fileset dir=".." includes="dependency/asm*.jar" />
            </classpath>

            <fileset dir="${basedir}">
                <include name="**/tests/TestFailureTypePassing.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="jvmcrash">
        <junit4.preconf>
            <fileset dir="${basedir}">
                <include name="**/tests/TestJvmCrash.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="antxml">
        <delete dir="ant-xmls" failonerror="false" />
        <mkdir dir="ant-xmls" />

        <junit4 haltonfailure="false">
            <classpath refid="tests.classpath" />

            <listeners>
                <report-ant-xml dir="ant-xmls">
                    <!--
                    <tokenfilter>
                      <replaceregex pattern="" replace="" flags="gi" />
                    </tokenfilter>
                    -->
                </report-ant-xml>
            </listeners>

            <fileset dir="${basedir}">
                <include name="**/tests/TestStatuses.class" />
                <include name="**/tests/TestSysstreams.class" />
                <include name="**/tests/TestIgnoredSuite.class" />
                <include name="**/tests/TestBeforeClassError.class" />
                <include name="**/tests/TestHierarchicalSuiteDescription.class" />
            </fileset>
        </junit4>
    </target>

    <target name="json">
        <delete dir="json" failonerror="false" />
        <mkdir dir="json" />

        <junit4 haltonfailure="false">
            <classpath refid="tests.classpath" />

            <listeners>
                <report-json file="json/report.json">
                </report-json>
            </listeners>

            <fileset dir="${basedir}">
                <include name="**/tests/TestStatuses.class" />
                <include name="**/tests/TestSysstreams.class" />
                <include name="**/tests/TestIgnoredSuite.class" />
                <include name="**/tests/TestBeforeClassError.class" />
                <include name="**/tests/TestHierarchicalSuiteDescription.class" />
            </fileset>
        </junit4>
    </target>

    <target name="classfilter">
    	<local name="tests.class" />
    	<property name="tests.class" value="*Statuses" />
        <junit4.preconf haltonfailure="false">
            <fileset dir="${basedir}">
                <include name="**/tests/Test*.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="methodfilter">
        <local name="tests.class" />
    	<local name="tests.method" />
        <property name="tests.class" value="*Statuses" />
    	<property name="tests.method" value="ignored*" />
        <junit4.preconf haltonfailure="false">
            <fileset dir="${basedir}">
                <include name="**/tests/Test*.class" />
            </fileset>
        </junit4.preconf>
    </target>

    <target name="nojunit-task">
        <taskdef name="junit4-nojunit" classname="com.carrotsearch.ant.tasks.junit4.JUnit4">
            <classpath>
                <fileset dir="..">
                    <include name="ant-junit4-*-standalone.jar" />
                </fileset>
            </classpath>
        </taskdef>

        <junit4-nojunit>
            <classpath refid="tests.classpath" />
            <fileset dir="${basedir}">
                <include name="**/tests/TestStatuses.class" />
            </fileset>
        </junit4-nojunit>
    </target>
    
    <target name="oldjunit-task">
        <taskdef name="junit4-oldjunit" classname="com.carrotsearch.ant.tasks.junit4.JUnit4">
            <classpath>
                <fileset dir="../..">
                    <include name="lib/junit-4.9.jar" />
                </fileset>
                <fileset dir="..">
                    <include name="ant-junit4-*-standalone.jar" />
                </fileset>
            </classpath>
        </taskdef>

        <junit4-oldjunit>
            <classpath refid="tests.classpath" />
            <fileset dir="${basedir}">
                <include name="**/tests/TestStatuses.class" />
            </fileset>
        </junit4-oldjunit>
    </target>
</project>