
<project name="junit4" default="normal">
    <path id="junit.classpath">
        <fileset dir="..">
            <include name="dependency/junit-*.jar" />
        </fileset>
    </path>

    <path id="tests.classpath">
        <path location="." />
        <path refid="junit.classpath" />
    </path>

    <taskdef resource="junit4.antlib.xml" loaderref="junit4.loader">
        <classpath refid="junit.classpath" />
        <classpath>
            <fileset dir="..">
                <include name="ant-junit4-*-standalone.jar" />
            </fileset>
        </classpath>
    </taskdef>

    <target name="all">
        <junit4 haltonfailure="true">
            <classpath refid="tests.classpath" />

            <listeners>
                <report-console
                	showErrors="true"
                	showStackTraces="true"
                	showOutputStream="true"
            	    showErrorStream="true"
                />
            </listeners>

            <fileset dir="${basedir}">
                <include name="**/tests/Test*.class" />
            	<exclude name="**/tests/TestJvmCrash*.class" />
            	<exclude name="**/*$*.class" />
            </fileset>
        </junit4>
    </target>

    <target name="normal">
        <junit4 haltonfailure="true">
            <classpath refid="tests.classpath" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestSub*.class" />
            </fileset>
        </junit4>
    </target>

    <target name="dir">
    	<delete dir="empty" failonerror="false" />
    	<mkdir dir="empty" />

        <junit4 dir="empty" haltonfailure="true">
            <classpath refid="tests.classpath" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestDir.class" />
            </fileset>
        </junit4>

    	<fail message="Expected marker file to appear.">
    		<condition>
    			  <not><available file="empty/touch.me" type="file" /></not>
		    </condition>
		</fail>
    </target>

    <target name="maxmem">
        <junit4 maxmemory="100m" haltonfailure="true">
            <classpath refid="tests.classpath" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestMaxMem.class" />
            </fileset>
        </junit4>
    </target>

    <target name="jvmarg">
        <junit4 haltonfailure="true">
            <classpath refid="tests.classpath" />

        	<jvmarg value="-Xmx100m"/>
        	<jvmarg value="-Dtest.param=foobar"/>

            <fileset dir="${basedir}">
                <include name="**/tests/TestMaxMem.class" />
            	<include name="**/tests/TestJvmArg.class" />
            </fileset>
        </junit4>
    </target>
	
    <target name="sysproperty">
        <junit4 haltonfailure="true">
            <classpath refid="tests.classpath" />
        	<sysproperty key="test.param" value="foobar" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestJvmArg.class" />
            </fileset>
        </junit4>
    </target>

    <target name="env">
        <junit4 haltonfailure="true">
            <classpath refid="tests.classpath" />

        	<env key="env.variable" value="foobar" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestEnvVar.class" />
            </fileset>
        </junit4>
    </target>

    <target name="failing">
        <junit4 haltonfailure="true">
            <classpath refid="tests.classpath" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestFailing.class" />
            </fileset>
        </junit4>
    </target>

    <target name="failingWithNonStandardException">
        <junit4 haltonfailure="true">
            <classpath refid="tests.classpath" />
        	<classpath>
        	  <fileset dir=".." includes="dependency/asm*.jar" />
        	</classpath>

            <fileset dir="${basedir}">
                <include name="**/tests/TestFailingWithNonStandardException.class" />
            </fileset>
        </junit4>
    </target>
	
    <target name="failureProperty">
        <junit4 haltonfailure="false" failureProperty="tests.failed">
            <classpath refid="tests.classpath" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestFailing.class" />
            </fileset>
        </junit4>

        <fail message="Expected failure property to be set.">
            <condition>
                  <not><isset property="tests.failed" /></not>
            </condition>
        </fail>    	
    </target>

    <target name="jvmcrash">
        <junit4 haltonfailure="true">
            <classpath refid="tests.classpath" />

            <fileset dir="${basedir}">
                <include name="**/tests/TestJvmCrash.class" />
            </fileset>
        </junit4>
    </target>

    <target name="nojunit">
        <junit4 haltonfailure="true">
            <fileset dir="${basedir}">
                <include name="**/tests/TestJvmCrash.class" />
            </fileset>
        </junit4>
    </target>   	
</project>